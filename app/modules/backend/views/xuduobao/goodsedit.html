<script src="/js/jquery.gcjs.js"></script>
<script src="/js/util.js"></script>
<script src="/js/require.js"></script>
<script src="/js/config.js"></script>
<script src="/js/bootstrap.min.js"></script>
<div class='wrapper main-wrapper wrapper-content '>
    <div class="page-content" style="width:1000px">

        <script type="text/javascript" src="/js/cascade.js"></script>
        <style type='text/css'>
            .tabs-container .form-group {overflow: hidden;}
            .tabs-container .tabs-left > .nav-tabs {width: 120px;}
            .tabs-container .tabs-left .panel-body {margin-left: 120px; width: 880px; text-align: left;}
            .tab-goods .nav li {width: 120px; text-align: right;}
            .spec_item_thumb {position: relative; width: 30px; height: 20px; padding: 0; border-left: none;}
            .spec_item_thumb i {position: absolute; top: -5px; right: -5px;}
        </style>
        <div class="page-heading">
            <h2>编辑商品 <small>{{ action }}【<span class="text-info">{{ goods['name'] }}</span>】</small></h2>
        </div>

        <form action="" method="post" class="form-horizontal form-validate" enctype="multipart/form-data">
            <input type="hidden" id="tab" name="token" value="{{ token }}" />
            <div class="tabs-container tab-goods">
                <div class="tabs-left">
                    <ul class="nav nav-tabs" id="myTab">
                        <li  class="active"><a href="#tab_basic">基本</a></li>
                        <li   ><a href="#tab_option">库存/规格</a></li>
                        <li  ><a href="#tab_des">详情</a></li>
                    </ul>

                    <div class="tab-content ">
                        <div class="tab-pane   active" id="tab_basic"><div class="panel-body"><div class="form-group">
                            <label class="col-sm-2 control-label">排序</label>
                            <div class="col-sm-9 col-xs-12">
                                <input type="text" name="sort" id="displayorder" class="form-control" value="{{ goods['sort'] }}"   />
                                <span class='help-block'>数字越大，排名越靠前,如果为空，默认排序方式为创建时间</span>
                            </div>
                        </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label must">商品名称</label>
                                <div class="col-sm-7"  style="padding-right:0;" >
                                    <input type="text" name="name" id="goodsname" class="form-control" value="{{ goods['name'] }}" data-rule-required="true" />
                                </div>
                                <div class="col-sm-2" style="padding-left:5px">
                                    <input type="text"  id="unit" class="form-control" value="" placeholder="单位, 如: 个/件/包"  />
                                </div>

                            </div>


                            <div class="form-group splitter"></div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label">商品分类</label>
                                <div class="col-sm-8 col-xs-12">
                                    <select id="cates"  name='category_id' class="form-control select2" style='width:605px;' multiple='' >
                                        {% for cate in cates %}
                                            <option value="{{ cate.id }}" {% if cate.id==goods['category_id'] %} selected {% endif %}>{{ cate.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>


                            <div class="form-group">
                                <label class="col-sm-2 control-label">商品属性</label>
                                <div class="col-sm-9 col-xs-12" >
                                    <label for="isrecommand" class="checkbox-inline">
                                        <input type="checkbox" name="fashion" value="1" id="isrecommand"  {% if goods['fashion'] %} checked {% endif %} /> 推荐
                                    </label>
                                    <label for="isnew" class="checkbox-inline">
                                        <input type="checkbox" name="new" value="1" id="isnew" {% if goods['new'] %} checked {% endif %}  /> 新品
                                    </label>
                                    <label for="ishot" class="checkbox-inline">
                                        <input type="checkbox" name="hot" value="1" id="ishot" {% if goods['hot'] %} checked {% endif %} /> 热卖
                                    </label>

                                </div>
                            </div>

                            <div class="form-group splitter"></div>


                            <div class="form-group">
                                <label class="col-sm-2 control-label">商品价格</label>
                                <div class="col-sm-9 col-xs-12">
                                    <div class="input-group">
                                        <input type="text" name="price" id="marketprice" class="form-control" value="{{ goods['price'] }}" />
                                        <span class="input-group-addon">元 原价</span>

                                    </div>
                                    <span class='help-block'>尽量填写完整，有助于于商品销售的数据分析</span>
                                </div>
                            </div>


                            <div class="form-group">
                                <label class="col-sm-2 control-label must">商品图片</label>
                                <div class="col-sm-9 col-xs-12 gimgs">

                                    <script type="text/javascript">
                                        function uploadMultiImage(elm) {
                                            var name = $(elm).next().val();
                                            util.image( "", function(urls){
                                                $.each(urls, function(idx, url){
                                                    $(elm).parent().parent().next().append('<div class="multi-item"><img onerror="this.src=\'./resource/images/nopic.jpg\'; this.title=\'图片未找到.\'" src="'+url.url+'" class="img-responsive img-thumbnail"><input type="hidden" name="'+name+'[]" value="'+url.attachment+'"><em class="close" title="删除这张图片" onclick="deleteMultiImage(this)">×</em></div>');
                                                });
                                            }, "", {"multiple":true,"direct":false});
                                        }
                                        function deleteMultiImage(elm){
                                            require(["jquery"], function($){
                                                $(elm).parent().remove();
                                            });
                                        }
                                    </script><div class="input-group">
                                    <input type="text" class="form-control" readonly="readonly" value="" placeholder="批量上传图片" autocomplete="off">
	<span class="input-group-btn">
		<button class="btn btn-default" type="button" onclick="uploadMultiImage(this);">选择图片</button>
		<input type="hidden" value="thumbs" />
	</span>
                                </div>
                                    <div class="input-group multi-img-details">
                                        <div class="multi-item">
                                            <img src="http://abc.5xieys.cn/attachment/images/2/2016/12/FcRyGV7FFwx3cwaNv7jJWBnvFjMM0A.jpg" onerror="this.src='./resource/images/nopic.jpg'; this.title='图片未找到.'" class="img-responsive img-thumbnail">
                                            <em class="close" title="删除这张图片" onclick="deleteMultiImage(this)">×</em>
                                        </div></div>        <span class="help-block image-block">第一张为缩略图，建议为正方型图片，其他为详情页面图片，尺寸建议宽度为640，并保持图片大小一致</span>
                                    <span class="help-block">您可以拖动图片改变其显示顺序 </span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label"></label>
                                <div class="col-sm-9 col-xs-12">
                                    <label class="checkbox-inline"><input type="checkbox"  value="1"    /> 详情显示首图</label>
                                    <span class="help-block"></span>
                                </div>
                            </div>

                            <div class="form-group" >
                                <label class="col-sm-2 control-label">已出售数</label>
                                <div class="col-sm-6 col-xs-12">
                                    <div class="input-group">
                                        <input type="text"  id="sales" class="form-control" value="1" />
                                        <span class="input-group-addon">件</span>
                                    </div>
                                    <span class="help-block">物品虚拟出售数，会员下单此数据就增加, 无论是否支付</span>
                                </div>
                            </div>
                            <div class="form-group splitter dispatch_info" ></div>


                            <div class="form-group splitter"></div>



                            <div class="form-group">
                                <label class="col-sm-2 control-label">上架</label>
                                <div class="col-sm-9 col-xs-12">
                                    <label class="radio-inline"><input type="radio" name="deleted" value="0"  /> 否</label>
                                    <label class="radio-inline"><input type="radio" name="deleted" value="1"  checked="true"   /> 上架</label>

                                </div>
                            </div>
                            <div class="form-group">
                                <input type="submit" value="保存商品" class="btn btn-primary"/>
                            </div>
                            <script language="javascript">
                                require(['jquery.ui'],function(){
                                    $('.multi-img-details').sortable();
                                })
                            </script></div></div>
                        <div class="tab-pane  " id="tab_option">
                            <div class="panel-body">
                            <div class="form-group">
                                <label class="col-sm-1 control-label">库存</label>
                                <div class="col-sm-11">
                                    <input type="text"  id="total" class="form-control hasoption" value="2220"  style="width:150px;display: inline;margin-right: 20px;" />
                                    <label class="checkbox-inline">
                                        <input type="checkbox" id="showtotal" value="1"   />显示库存
                                    </label>
                                    <span class="help-block">商品的剩余数量, 如启用多规格或为虚拟卡密产品，则此处设置无效.</span>
                                </div>
                            </div>


                            <div class="form-group">
                                <div class="col-sm-11" style='padding-left:30px;'>
                                    <label class="checkbox-inline">
                                        <input type="checkbox" id="hasoption" value="1"   />启用商品规格
                                    </label>
                                    <span class="help-block">启用商品规格后，商品的价格及库存以商品规格为准,库存设置为0则会到”已售罄“中，手机也不会显示, -1为不限制</span>

                                </div>
                            </div>
                                <div class='form-group'>
                                    <input type="submit" value="保存商品" class="btn btn-primary"/>
                                </div>
                            <div id='tboption' style="padding-left:15px;display:none" >
                                <div class="alert alert-info">
                                    1. 拖动规格可调整规格显示顺序, 更改规格及规格项后请点击下方的【刷新规格项目表】来更新数据。<br/>
                                    2. 每一种规格代表不同型号，例如颜色为一种规格，尺寸为一种规格，如果设置多规格，手机用户必须每一种规格都选择一个规格项，才能添加购物车或购买。
                                </div>
                                <div id='specs'>
                                </div>
                                <table class="table">
                                    <tr>
                                        <td>
                                            <h4><a href="javascript:;" class='btn btn-primary' id='add-spec' onclick="addSpec()" style="margin-top:10px;margin-bottom:10px;" title="添加规格"><i class='fa fa-plus'></i> 添加规格</a>
                                                <a href="javascript:;" onclick="refreshOptions();" title="刷新规格项目表" class="btn btn-primary"><i class="fa fa-refresh"></i> 刷新规格项目表</a></h4>
                                        </td>
                                    </tr>
                                </table>
                                <div id="options" style="padding:0;"></div>
                            </div>
                            <input type="hidden" name="optionArray" value=''>
                            <input type="hidden" name="isdiscountDiscountsArray" value=''>
                            <input type="hidden" name="discountArray" value=''>
                            <input type="hidden" name="commissionArray" value=''>
                            <script language="javascript">
                                $(function(){
                                    $(".spec_item_thumb").find('i').click(function(){
                                        var group  =$(this).parent();
                                        group.find('img').attr('src',"../addons/ewei_shopv2/static/images/nopic100.jpg");
                                        group.find(':hidden').val('');
                                        $(this).hide();
                                        group.find('img').popover('destroy');
                                    });

                                    require(['jquery.ui'],function(){
                                        $('#specs').sortable({
                                            stop: function(){
                                                refreshOptions();
                                            }
                                        });
                                        $('.spec_item_items').sortable(
                                                {
                                                    handle:'.fa-arrows',
                                                    stop: function(){
                                                        refreshOptions();
                                                    }
                                                }
                                        );
                                    });
                                    $("#hasoption").click(function(){
                                        var obj = $(this);
                                        if (obj.get(0).checked){
                                            refreshOptions();
                                            $('.hasoption').attr('readonly',true);
                                            $("#tboption").show();
                                            $("#tbdiscount").show();
                                            $("#isdiscount_discounts").show();
                                            $("#isdiscount_discounts_default").hide();
                                            $("#commission").show();
                                            $("#commission_default").hide();
                                            $("#discounts_type1").show().parent().show();
                                        }else{
                                            $("#tboption").hide();
                                            refreshOptions();

                                            $("#isdiscount_discounts").hide();
                                            var isdiscount_discounts = $("#isdiscount_discounts").html();
                                            $("#isdiscount_discounts").html('');
                                            isdiscount_change();
                                            $("#isdiscount_discounts").html(isdiscount_discounts);

                                            $("#commission").hide();
                                            var commission = $("#commission").html();
                                            $("#commission").html('');
                                            commission_change();
                                            $("#commission").html(commission);

                                            $("#tbdiscount").hide();
                                            $("#isdiscount_discounts_default").show();

                                            $("#commission_default").show();
                                            $('.hasoption').removeAttr('readonly');

                                            $("#discounts_type1").hide().parent().hide();
                                            $("#discounts_type0").click();
                                        }
                                    });
                                });
                                function selectSpecItemImage(obj){
                                    util.image('',function(val){
                                        $(obj).attr('src',val.url).popover({
                                            trigger: 'hover',
                                            html: true,
                                            container: $(document.body),
                                            content: "<img src='" + val.url  + "' style='width:100px;height:100px;' />",
                                            placement: 'top'
                                        });

                                        var group  =$(obj).parent();

                                        group.find(':hidden').val(val.attachment), group.find('i').show().unbind('click').click(function(){
                                            $(obj).attr('src',"../addons/ewei_shopv2/static/images/nopic100.jpg");
                                            group.find(':hidden').val('');
                                            group.find('i').hide();
                                            $(obj).popover('destroy');
                                        });
                                    });
                                }
                                function addSpec(){
                                    var len = $(".spec_item").length;

                                    if(type==3 && virtual==0 && len>=1){
                                        tip.msgbox.err('您的商品类型为：虚拟物品(卡密)的多规格形式，只能添加一种规格！');
                                        return;
                                    }
                                    if(type==10 && len>=1){
                                        tip.msgbox.err('您的商品类型为：话费流量充值，只能添加一种规格！')
                                        return;
                                    }

                                    $("#add-spec").html("正在处理...").attr("disabled", "true").toggleClass("btn-primary");
                                    var url = "http://abc.5xieys.cn/web/index.php?c=site&a=entry&m=ewei_shopv2&do=web&r=goods.tpl&tpl=spec";
                                    $.ajax({
                                        "url": url,
                                        success:function(data){
                                            $("#add-spec").html('<i class="fa fa-plus"></i> 添加规格').removeAttr("disabled").toggleClass("btn-primary"); ;
                                            $('#specs').append(data);
                                            var len = $(".add-specitem").length -1;
                                            $(".add-specitem:eq(" +len+ ")").focus();
                                            refreshOptions();
                                        }
                                    });
                                }
                                function removeSpec(specid){
                                    if (confirm('确认要删除此规格?')){
                                        $("#spec_" + specid).remove();
                                        refreshOptions();
                                    }
                                }
                                function addSpecItem(specid){
                                    $("#add-specitem-" + specid).html("正在处理...").attr("disabled", "true");
                                    var url = "http://abc.5xieys.cn/web/index.php?c=site&a=entry&m=ewei_shopv2&do=web&r=goods.tpl&tpl=specitem" + "&specid=" + specid;
                                    $.ajax({
                                        "url": url,
                                        success:function(data){
                                            $("#add-specitem-" + specid).html('<i class="fa fa-plus"></i> 添加规格项').removeAttr("disabled");
                                            $('#spec_item_' + specid).append(data);
                                            var len = $("#spec_" + specid + " .spec_item_title").length -1;
                                            $("#spec_" + specid + " .spec_item_title:eq(" +len+ ")").focus();
                                            refreshOptions
                                            if(type==3 && virtual==0){
                                                $(".choosetemp").show();
                                            }
                                        }
                                    });
                                }
                                function removeSpecItem(obj){
                                    $(obj).closest('.spec_item_item').remove();
                                    refreshOptions();
                                }

                                function refreshOptions(){
                                    var html = '<table class="table table-bordered table-condensed"><thead><tr class="active">';
                                    var specs = [];
                                    if($('.spec_item').length<=0){
                                        $("#options").html('');
                                        $("#discount").html('');
                                        $("#isdiscount_discounts").html('');
                                        $("#commission").html('');
                                        commission_change();
                                        isdiscount_change();
                                        return;
                                    }
                                    $(".spec_item").each(function(i){
                                        var _this = $(this);

                                        var spec = {
                                            id: _this.find(".spec_id").val(),
                                            title: _this.find(".spec_title").val()
                                        };

                                        var items = [];
                                        _this.find(".spec_item_item").each(function(){
                                            var __this = $(this);
                                            var item = {
                                                id: __this.find(".spec_item_id").val(),
                                                title: __this.find(".spec_item_title").val(),
                                                virtual: __this.find(".spec_item_virtual").val(),
                                                show:__this.find(".spec_item_show").get(0).checked?"1":"0"
                                            }
                                            items.push(item);
                                        });
                                        spec.items = items;
                                        specs.push(spec);
                                    });
                                    specs.sort(function(x,y){
                                        if (x.items.length > y.items.length){
                                            return 1;
                                        }
                                        if (x.items.length < y.items.length) {
                                            return -1;
                                        }
                                    });

                                    var len = specs.length;
                                    var newlen = 1;
                                    var h = new Array(len);
                                    var rowspans = new Array(len);
                                    for(var i=0;i<len;i++){
                                        html+="<th>" + specs[i].title + "</th>";
                                        var itemlen = specs[i].items.length;
                                        if(itemlen<=0) { itemlen = 1 };
                                        newlen*=itemlen;

                                        h[i] = new Array(newlen);
                                        for(var j=0;j<newlen;j++){
                                            h[i][j] = new Array();
                                        }
                                        var l = specs[i].items.length;
                                        rowspans[i] = 1;
                                        for(j=i+1;j<len;j++){
                                            rowspans[i]*= specs[j].items.length;
                                        }
                                    }

                                    html += '<th><div class=""><div style="padding-bottom:10px;text-align:center;">库存</div><div class="input-group"><input type="text" class="form-control  input-sm option_stock_all"VALUE=""/><span class="input-group-addon"><a href="javascript:;" class="fa fa-angle-double-down" title="批量设置" onclick="setCol(\'option_stock\');"></a></span></div></div></th>';
                                    html += '<th><div class=""><div style="padding-bottom:10px;text-align:center;">现价</div><div class="input-group"><input type="text" class="form-control  input-sm option_marketprice_all"VALUE=""/><span class="input-group-addon"><a href="javascript:;" class="fa fa-angle-double-down" title="批量设置" onclick="setCol(\'option_marketprice\');"></a></span></div></div></th>';
                                    html+='<th><div class=""><div style="padding-bottom:10px;text-align:center;">原价</div><div class="input-group"><input type="text" class="form-control  input-sm option_productprice_all"VALUE=""/><span class="input-group-addon"><a href="javascript:;" class="fa fa-angle-double-down" title="批量设置" onclick="setCol(\'option_productprice\');"></a></span></div></div></th>';
                                    html+='<th><div class=""><div style="padding-bottom:10px;text-align:center;">成本价</div><div class="input-group"><input type="text" class="form-control  input-sm option_costprice_all"VALUE=""/><span class="input-group-addon"><a href="javascript:;" class="fa fa-angle-double-down" title="批量设置" onclick="setCol(\'option_costprice\');"></a></span></div></div></th>';
                                    html+='<th><div class=""><div style="padding-bottom:10px;text-align:center;">编码</div><div class="input-group"><input type="text" class="form-control  input-sm option_goodssn_all"VALUE=""/><span class="input-group-addon"><a href="javascript:;" class="fa fa-angle-double-down" title="批量设置" onclick="setCol(\'option_goodssn\');"></a></span></div></div></th>';
                                    html+='<th><div class=""><div style="padding-bottom:10px;text-align:center;">条码</div><div class="input-group"><input type="text" class="form-control  input-sm option_productsn_all"VALUE=""/><span class="input-group-addon"><a href="javascript:;" class="fa fa-angle-double-down" title="批量设置" onclick="setCol(\'option_productsn\');"></a></span></div></div></th>';
                                    html+='<th><div class=""><div style="padding-bottom:10px;text-align:center;">重量（克）</div><div class="input-group"><input type="text" class="form-control  input-sm option_weight_all"VALUE=""/><span class="input-group-addon"><a href="javascript:;" class="fa fa-angle-double-down" title="批量设置" onclick="setCol(\'option_weight\');"></a></span></div></div></th>';
                                    html+='</tr></thead>';

                                    for(var m=0;m<len;m++){
                                        var k = 0,kid = 0,n=0;
                                        for(var j=0;j<newlen;j++){
                                            var rowspan = rowspans[m];
                                            if( j % rowspan==0){
                                                h[m][j]={title: specs[m].items[kid].title, virtual: specs[m].items[kid].virtual,html: "<td class='full' rowspan='" +rowspan + "'>"+ specs[m].items[kid].title+"</td>\r\n",id: specs[m].items[kid].id};
                                            }
                                            else{
                                                h[m][j]={title:specs[m].items[kid].title,virtual: specs[m].items[kid].virtual, html: "",id: specs[m].items[kid].id};
                                            }
                                            n++;
                                            if(n==rowspan){
                                                kid++; if(kid>specs[m].items.length-1) { kid=0; }
                                                n=0;
                                            }
                                        }
                                    }

                                    var hh = "";
                                    for(var i=0;i<newlen;i++){
                                        hh+="<tr>";
                                        var ids = [];
                                        var titles = [];
                                        var virtuals = [];
                                        for(var j=0;j<len;j++){
                                            hh+=h[j][i].html;
                                            ids.push( h[j][i].id);
                                            titles.push( h[j][i].title);
                                            virtuals.push( h[j][i].virtual);
                                        }
                                        ids =ids.join('_');
                                        titles= titles.join('+');

                                        var val ={ id : "",title:titles, stock : "",costprice : "",productprice : "",marketprice : "",weight:"",productsn:"",goodssn:"",virtual:virtuals };
                                        if( $(".option_id_" + ids).length>0){
                                            val ={
                                                id : $(".option_id_" + ids+":eq(0)").val(),
                                                title: titles,
                                                stock : $(".option_stock_" + ids+":eq(0)").val(),
                                                costprice : $(".option_costprice_" + ids+":eq(0)").val(),
                                                productprice : $(".option_productprice_" + ids+":eq(0)").val(),
                                                marketprice : $(".option_marketprice_" + ids +":eq(0)").val(),
                                                goodssn : $(".option_goodssn_" + ids +":eq(0)").val(),
                                                productsn : $(".option_productsn_" + ids +":eq(0)").val(),
                                                weight : $(".option_weight_" + ids+":eq(0)").val(),
                                                virtual : virtuals
                                            }
                                        }

                                        hh += '<td>'
                                        hh += '<input data-name="option_stock_' + ids +'" type="text" class="form-control option_stock option_stock_' + ids +'" value="' +(val.stock=='undefined'?'':val.stock )+'"/></td>';
                                        hh += '<input data-name="option_id_' + ids+'" type="hidden" class="form-control option_id option_id_' + ids +'" value="' +(val.id=='undefined'?'':val.id )+'"/>';
                                        hh += '<input data-name="option_ids" type="hidden" class="form-control option_ids option_ids_' + ids +'" value="' + ids +'"/>';
                                        hh += '<input data-name="option_title_' + ids +'" type="hidden" class="form-control option_title option_title_' + ids +'" value="' +(val.title=='undefined'?'':val.title )+'"/></td>';
                                        hh += '<input data-name="option_virtual_' + ids +'" type="hidden" class="form-control option_virtual option_virtual_' + ids +'" value="' +(val.virtual=='undefined'?'':val.virtual )+'"/></td>';
                                        hh += '</td>';
                                        hh += '<td><input data-name="option_marketprice_' + ids+'" type="text" class="form-control option_marketprice option_marketprice_' + ids +'" value="' +(val.marketprice=='undefined'?'':val.marketprice )+'"/></td>';
                                        hh += '<td><input data-name="option_productprice_' + ids+'" type="text" class="form-control option_productprice option_productprice_' + ids +'" " value="' +(val.productprice=='undefined'?'':val.productprice )+'"/></td>';
                                        hh += '<td><input data-name="option_costprice_' +ids+'" type="text" class="form-control option_costprice option_costprice_' + ids +'" " value="' +(val.costprice=='undefined'?'':val.costprice )+'"/></td>';
                                        hh += '<td><input data-name="option_goodssn_' +ids+'" type="text" class="form-control option_goodssn option_goodssn_' + ids +'" " value="' +(val.goodssn=='undefined'?'':val.goodssn )+'"/></td>';
                                        hh += '<td><input data-name="option_productsn_' +ids+'" type="text" class="form-control option_productsn option_productsn_' + ids +'" " value="' +(val.productsn=='undefined'?'':val.productsn )+'"/></td>';
                                        hh += '<td><input data-name="option_weight_' + ids +'" type="text" class="form-control option_weight option_weight_' + ids +'" " value="' +(val.weight=='undefined'?'':val.weight )+'"/></td>';
                                        hh += "</tr>";
                                    }
                                    html+=hh;
                                    html+="</table>";
                                    $("#options").html(html);
                                    refreshDiscount();
                                    refreshIsDiscount();
                                    refreshCommission();
                                    commission_change();
                                    isdiscount_change();
                                }

                                function refreshDiscount() {
                                    var html = '<table class="table table-bordered table-condensed"><thead><tr class="active">';
                                    var specs = [];

                                    $(".spec_item").each(function (i) {
                                        var _this = $(this);

                                        var spec = {
                                            id: _this.find(".spec_id").val(),
                                            title: _this.find(".spec_title").val()
                                        };

                                        var items = [];
                                        _this.find(".spec_item_item").each(function () {
                                            var __this = $(this);
                                            var item = {
                                                id: __this.find(".spec_item_id").val(),
                                                title: __this.find(".spec_item_title").val(),
                                                virtual: __this.find(".spec_item_virtual").val(),
                                                show: __this.find(".spec_item_show").get(0).checked ? "1" : "0"
                                            }
                                            items.push(item);
                                        });
                                        spec.items = items;
                                        specs.push(spec);
                                    });
                                    specs.sort(function (x, y) {
                                        if (x.items.length > y.items.length) {
                                            return 1;
                                        }
                                        if (x.items.length < y.items.length) {
                                            return -1;
                                        }
                                    });

                                    var len = specs.length;
                                    var newlen = 1;
                                    var h = new Array(len);
                                    var rowspans = new Array(len);
                                    for (var i = 0; i < len; i++) {
                                        html += "<th>" + specs[i].title + "</th>";
                                        var itemlen = specs[i].items.length;
                                        if (itemlen <= 0) {
                                            itemlen = 1
                                        }
                                        ;
                                        newlen *= itemlen;

                                        h[i] = new Array(newlen);
                                        for (var j = 0; j < newlen; j++) {
                                            h[i][j] = new Array();
                                        }
                                        var l = specs[i].items.length;
                                        rowspans[i] = 1;
                                        for (j = i + 1; j < len; j++) {
                                            rowspans[i] *= specs[j].items.length;
                                        }
                                    }

                                    html += '<th><div class=""><div style="padding-bottom:10px;text-align:center;">默认会员</div><div class="input-group"><input type="text" class="form-control  input-sm discount_default_all"VALUE=""/><span class="input-group-addon"><a href="javascript:;" class="fa fa-angle-double-down" title="批量设置" onclick="setCol(\'discount_default\');"></a></span></div></div></th>';
                                    html += '</tr></thead>';

                                    for (var m = 0; m < len; m++) {
                                        var k = 0, kid = 0, n = 0;
                                        for (var j = 0; j < newlen; j++) {
                                            var rowspan = rowspans[m];
                                            if (j % rowspan == 0) {
                                                h[m][j] = {
                                                    title: specs[m].items[kid].title,
                                                    virtual: specs[m].items[kid].virtual,
                                                    html: "<td class='full' rowspan='" + rowspan + "'>" + specs[m].items[kid].title + "</td>\r\n",
                                                    id: specs[m].items[kid].id
                                                };
                                            }
                                            else {
                                                h[m][j] = {
                                                    title: specs[m].items[kid].title,
                                                    virtual: specs[m].items[kid].virtual,
                                                    html: "",
                                                    id: specs[m].items[kid].id
                                                };
                                            }
                                            n++;
                                            if (n == rowspan) {
                                                kid++;
                                                if (kid > specs[m].items.length - 1) {
                                                    kid = 0;
                                                }
                                                n = 0;
                                            }
                                        }
                                    }

                                    var hh = "";
                                    for (var i = 0; i < newlen; i++) {
                                        hh += "<tr>";
                                        var ids = [];
                                        var titles = [];
                                        var virtuals = [];
                                        for (var j = 0; j < len; j++) {
                                            hh += h[j][i].html;
                                            ids.push(h[j][i].id);
                                            titles.push(h[j][i].title);
                                            virtuals.push(h[j][i].virtual);
                                        }
                                        ids = ids.join('_');
                                        titles = titles.join('+');
                                        var val = {
                                            id: "",
                                            title: titles,
                                            leveldefault: '',
                                            costprice: "",
                                            productprice: "",
                                            marketprice: "",
                                            weight: "",
                                            productsn: "",
                                            goodssn: "",
                                            virtual: virtuals
                                        };

                                        var val ={ id : "",title:titles, leveldefault: '',costprice : "",productprice : "",marketprice : "",weight:"",productsn:"",goodssn:"",virtual:virtuals };
                                        if ($(".discount_id_" + ids).length > 0) {
                                            val = {
                                                id: $(".discount_id_" + ids + ":eq(0)").val(),
                                                title: titles,
                                                leveldefault: $(".discount_default_" + ids + ":eq(0)").val(),
                                                costprice: $(".discount_costprice_" + ids + ":eq(0)").val(),
                                                productprice: $(".discount_productprice_" + ids + ":eq(0)").val(),
                                                marketprice: $(".discount_marketprice_" + ids + ":eq(0)").val(),
                                                goodssn: $(".discount_goodssn_" + ids + ":eq(0)").val(),
                                                productsn: $(".discount_productsn_" + ids + ":eq(0)").val(),
                                                weight: $(".discount_weight_" + ids + ":eq(0)").val(),
                                                virtual: virtuals
                                            }
                                        }

                                        hh += '<td>'
                                        hh += '<input data-name="discount_level_default_' + ids +'"type="text" class="form-control discount_default discount_default_' + ids +'" value="' +(val.leveldefault=='undefined'?'':val.leveldefault )+'"/>';
                                        hh += '</td>';
                                        hh += '<input data-name="discount_id_' + ids+'"type="hidden" class="form-control discount_id discount_id_' + ids +'" value="' +(val.id=='undefined'?'':val.id )+'"/>';
                                        hh += '<input data-name="discount_ids"type="hidden" class="form-control discount_ids discount_ids_' + ids +'" value="' + ids +'"/>';
                                        hh += '<input data-name="discount_title_' + ids +'"type="hidden" class="form-control discount_title discount_title_' + ids +'" value="' +(val.title=='undefined'?'':val.title )+'"/></td>';
                                        hh += '<input data-name="discount_virtual_' + ids +'"type="hidden" class="form-control discount_virtual discount_virtual_' + ids +'" value="' +(val.virtual=='undefined'?'':val.virtual )+'"/></td>';
                                        hh += "</tr>";
                                    }
                                    html += hh;
                                    html += "</table>";
                                    $("#discount").html(html);
                                }

                                function refreshIsDiscount() {
                                    var html = '<table class="table table-bordered table-condensed"><thead><tr class="active">';
                                    var specs = [];

                                    $(".spec_item").each(function (i) {
                                        var _this = $(this);

                                        var spec = {
                                            id: _this.find(".spec_id").val(),
                                            title: _this.find(".spec_title").val()
                                        };

                                        var items = [];
                                        _this.find(".spec_item_item").each(function () {
                                            var __this = $(this);
                                            var item = {
                                                id: __this.find(".spec_item_id").val(),
                                                title: __this.find(".spec_item_title").val(),
                                                virtual: __this.find(".spec_item_virtual").val(),
                                                show: __this.find(".spec_item_show").get(0).checked ? "1" : "0"
                                            }
                                            items.push(item);
                                        });
                                        spec.items = items;
                                        specs.push(spec);
                                    });
                                    specs.sort(function (x, y) {
                                        if (x.items.length > y.items.length) {
                                            return 1;
                                        }
                                        if (x.items.length < y.items.length) {
                                            return -1;
                                        }
                                    });

                                    var len = specs.length;
                                    var newlen = 1;
                                    var h = new Array(len);
                                    var rowspans = new Array(len);
                                    for (var i = 0; i < len; i++) {
                                        html += "<th>" + specs[i].title + "</th>";
                                        var itemlen = specs[i].items.length;
                                        if (itemlen <= 0) {
                                            itemlen = 1
                                        }
                                        ;
                                        newlen *= itemlen;

                                        h[i] = new Array(newlen);
                                        for (var j = 0; j < newlen; j++) {
                                            h[i][j] = new Array();
                                        }
                                        var l = specs[i].items.length;
                                        rowspans[i] = 1;
                                        for (j = i + 1; j < len; j++) {
                                            rowspans[i] *= specs[j].items.length;
                                        }
                                    }

                                    html += '<th><div class=""><div style="padding-bottom:10px;text-align:center;">默认会员</div><div class="input-group"><input type="text" class="form-control  input-sm isdiscount_discounts_default_all"VALUE=""/><span class="input-group-addon"><a href="javascript:;" class="fa fa-angle-double-down" title="批量设置" onclick="setCol(\'isdiscount_discounts_default\');"></a></span></div></div></th>';
                                    html += '</tr></thead>';

                                    for (var m = 0; m < len; m++) {
                                        var k = 0, kid = 0, n = 0;
                                        for (var j = 0; j < newlen; j++) {
                                            var rowspan = rowspans[m];
                                            if (j % rowspan == 0) {
                                                h[m][j] = {
                                                    title: specs[m].items[kid].title,
                                                    virtual: specs[m].items[kid].virtual,
                                                    html: "<td class='full' rowspan='" + rowspan + "'>" + specs[m].items[kid].title + "</td>\r\n",
                                                    id: specs[m].items[kid].id
                                                };
                                            }
                                            else {
                                                h[m][j] = {
                                                    title: specs[m].items[kid].title,
                                                    virtual: specs[m].items[kid].virtual,
                                                    html: "",
                                                    id: specs[m].items[kid].id
                                                };
                                            }
                                            n++;
                                            if (n == rowspan) {
                                                kid++;
                                                if (kid > specs[m].items.length - 1) {
                                                    kid = 0;
                                                }
                                                n = 0;
                                            }
                                        }
                                    }

                                    var hh = "";
                                    for (var i = 0; i < newlen; i++) {
                                        hh += "<tr>";
                                        var ids = [];
                                        var titles = [];
                                        var virtuals = [];
                                        for (var j = 0; j < len; j++) {
                                            hh += h[j][i].html;
                                            ids.push(h[j][i].id);
                                            titles.push(h[j][i].title);
                                            virtuals.push(h[j][i].virtual);
                                        }
                                        ids = ids.join('_');
                                        titles = titles.join('+');
                                        var val = {
                                            id: "",
                                            title: titles,
                                            leveldefault: '',
                                            costprice: "",
                                            productprice: "",
                                            marketprice: "",
                                            weight: "",
                                            productsn: "",
                                            goodssn: "",
                                            virtual: virtuals
                                        };

                                        var val ={ id : "",title:titles, leveldefault: '',costprice : "",productprice : "",marketprice : "",weight:"",productsn:"",goodssn:"",virtual:virtuals };
                                        if ($(".isdiscount_discounts_id_" + ids).length > 0) {
                                            val = {
                                                id: $(".isdiscount_discounts_id_" + ids + ":eq(0)").val(),
                                                title: titles,
                                                leveldefault: $(".isdiscount_discounts_default_" + ids + ":eq(0)").val(),
                                                costprice: $(".isdiscount_discounts_costprice_" + ids + ":eq(0)").val(),
                                                productprice: $(".isdiscount_discounts_productprice_" + ids + ":eq(0)").val(),
                                                marketprice: $(".isdiscount_discounts_marketprice_" + ids + ":eq(0)").val(),
                                                goodssn: $(".isdiscount_discounts_goodssn_" + ids + ":eq(0)").val(),
                                                productsn: $(".isdiscount_discounts_productsn_" + ids + ":eq(0)").val(),
                                                weight: $(".isdiscount_discounts_weight_" + ids + ":eq(0)").val(),
                                                virtual: virtuals
                                            }
                                        }

                                        hh += '<td>'
                                        hh += '<input data-name="isdiscount_discounts_level_default_' + ids +'"type="text" class="form-control isdiscount_discounts_default isdiscount_discounts_default_' + ids +'" value="' +(val.leveldefault=='undefined'?'':val.leveldefault )+'"/>';
                                        hh += '</td>';
                                        hh += '<input data-name="isdiscount_discounts_id_' + ids+'"type="hidden" class="form-control isdiscount_discounts_id isdiscount_discounts_id_' + ids +'" value="' +(val.id=='undefined'?'':val.id )+'"/>';
                                        hh += '<input data-name="isdiscount_discounts_ids"type="hidden" class="form-control isdiscount_discounts_ids isdiscount_discounts_ids_' + ids +'" value="' + ids +'"/>';
                                        hh += '<input data-name="isdiscount_discounts_title_' + ids +'"type="hidden" class="form-control isdiscount_discounts_title isdiscount_discounts_title_' + ids +'" value="' +(val.title=='undefined'?'':val.title )+'"/></td>';
                                        hh += '<input data-name="isdiscount_discounts_virtual_' + ids +'"type="hidden" class="form-control isdiscount_discounts_virtual isdiscount_discounts_virtual_' + ids +'" value="' +(val.virtual=='undefined'?'':val.virtual )+'"/></td>';
                                        hh += "</tr>";
                                    }
                                    html += hh;
                                    html += "</table>";
                                    $("#isdiscount_discounts").html(html);
                                }

                                function refreshCommission() {
                                    var commission_level = [{"key":"default","levelname":"\u9ed8\u8ba4\u7b49\u7ea7"}];
                                    var html = '<table class="table table-bordered table-condensed"><thead><tr class="active">';
                                    var specs = [];

                                    $(".spec_item").each(function (i) {
                                        var _this = $(this);

                                        var spec = {
                                            id: _this.find(".spec_id").val(),
                                            title: _this.find(".spec_title").val()
                                        };

                                        var items = [];
                                        _this.find(".spec_item_item").each(function () {
                                            var __this = $(this);
                                            var item = {
                                                id: __this.find(".spec_item_id").val(),
                                                title: __this.find(".spec_item_title").val(),
                                                virtual: __this.find(".spec_item_virtual").val(),
                                                show: __this.find(".spec_item_show").get(0).checked ? "1" : "0"
                                            }
                                            items.push(item);
                                        });
                                        spec.items = items;
                                        specs.push(spec);
                                    });
                                    specs.sort(function (x, y) {
                                        if (x.items.length > y.items.length) {
                                            return 1;
                                        }
                                        if (x.items.length < y.items.length) {
                                            return -1;
                                        }
                                    });

                                    var len = specs.length;
                                    var newlen = 1;
                                    var h = new Array(len);
                                    var rowspans = new Array(len);
                                    for (var i = 0; i < len; i++) {
                                        html += "<th>" + specs[i].title + "</th>";
                                        var itemlen = specs[i].items.length;
                                        if (itemlen <= 0) {
                                            itemlen = 1
                                        }
                                        ;
                                        newlen *= itemlen;

                                        h[i] = new Array(newlen);
                                        for (var j = 0; j < newlen; j++) {
                                            h[i][j] = new Array();
                                        }
                                        var l = specs[i].items.length;
                                        rowspans[i] = 1;
                                        for (j = i + 1; j < len; j++) {
                                            rowspans[i] *= specs[j].items.length;
                                        }
                                    }

                                    $.each(commission_level,function (key,level) {
                                        html += '<th><div class=""><div style="padding-bottom:10px;text-align:center;">'+level.levelname+'</div></div></th>';
                                    })
                                    html += '</tr></thead>';

                                    for (var m = 0; m < len; m++) {
                                        var k = 0, kid = 0, n = 0;
                                        for (var j = 0; j < newlen; j++) {
                                            var rowspan = rowspans[m];
                                            if (j % rowspan == 0) {
                                                h[m][j] = {
                                                    title: specs[m].items[kid].title,
                                                    virtual: specs[m].items[kid].virtual,
                                                    html: "<td class='full' rowspan='" + rowspan + "'>" + specs[m].items[kid].title + "</td>\r\n",
                                                    id: specs[m].items[kid].id
                                                };
                                            }
                                            else {
                                                h[m][j] = {
                                                    title: specs[m].items[kid].title,
                                                    virtual: specs[m].items[kid].virtual,
                                                    html: "",
                                                    id: specs[m].items[kid].id
                                                };
                                            }
                                            n++;
                                            if (n == rowspan) {
                                                kid++;
                                                if (kid > specs[m].items.length - 1) {
                                                    kid = 0;
                                                }
                                                n = 0;
                                            }
                                        }
                                    }
                                    var hh = "";
                                    for (var i = 0; i < newlen; i++) {
                                        hh += "<tr>";
                                        var ids = [];
                                        var titles = [];
                                        var virtuals = [];
                                        for (var j = 0; j < len; j++) {
                                            hh += h[j][i].html;
                                            ids.push(h[j][i].id);
                                            titles.push(h[j][i].title);
                                            virtuals.push(h[j][i].virtual);
                                        }
                                        ids = ids.join('_');
                                        titles = titles.join('+');

                                        var val = {
                                            id: "",
                                            title: titles,
                                            leveldefault: '',
                                            costprice: "",
                                            productprice: "",
                                            marketprice: "",
                                            weight: "",
                                            productsn: "",
                                            goodssn: "",
                                            virtual: virtuals
                                        };

                                        var val ={ id : "",title:titles, leveldefault: '',costprice : "",productprice : "",marketprice : "",weight:"",productsn:"",goodssn:"",virtual:virtuals };
                                        var leveldefault = new Array(3);
                                        $(".commission_default_"+ ids).each(function(index,val){
                                            leveldefault[index] = val;
                                        })
                                        if ($(".commission_id_" + ids).length > 0) {
                                            val = {
                                                id: $(".commission_id_" + ids + ":eq(0)").val(),
                                                title: titles,
                                                costprice: $(".commission_costprice_" + ids + ":eq(0)").val(),
                                                productprice: $(".commission_productprice_" + ids + ":eq(0)").val(),
                                                marketprice: $(".commission_marketprice_" + ids + ":eq(0)").val(),
                                                goodssn: $(".commission_goodssn_" + ids + ":eq(0)").val(),
                                                productsn: $(".commission_productsn_" + ids + ":eq(0)").val(),
                                                weight: $(".commission_weight_" + ids + ":eq(0)").val(),
                                                virtual: virtuals
                                            }
                                        }
                                        hh += '<td>';
                                        var level_temp = leveldefault;
                                        if (len >= i && typeof (level_temp) != 'undefined')
                                        {
                                            if('default' == 'default')
                                            {
                                                for (var li = 0; li<3;li++)
                                                {
                                                    if (typeof (level_temp[li])!= "undefined")
                                                    {
                                                        hh += '<input data-name="commission_level_default_' +ids+ '"  type="text" class="form-control commission_default commission_default_' +ids+ '" value="' +$(level_temp[li]).val()+ '" style="display:inline;width: '+96/parseInt(3)+'%;"/> ';
                                                    }
                                                    else
                                                    {
                                                        hh += '<input data-name="commission_level_default_' +ids+ '"  type="text" class="form-control commission_default commission_default_' +ids+ '" value="" style="display:inline;width: '+96/parseInt(3)+'%;"/> ';
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                for (var li = 0; li<3;li++)
                                                {
                                                    if (typeof (level_temp[li])!= "undefined")
                                                    {
                                                        hh += '<input data-name="commission_level__' +ids+ '"  type="text" class="form-control commission_level commission_level_' +ids+ '" value="' +$(level_temp[li]).val()+ '" style="display:inline;width: '+96/parseInt(3)+'%;"/> ';
                                                    }
                                                    else
                                                    {
                                                        hh += '<input data-name="commission_level__' +ids+ '"  type="text" class="form-control commission_level commission_level_' +ids+ '" value="" style="display:inline;width: '+96/parseInt(3)+'%;"/> ';
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            if('default' == 'default')
                                            {
                                                for (var li = 0; li<3;li++)
                                                {
                                                    if (typeof (level_temp[li])!= "undefined")
                                                    {
                                                        hh += '<input data-name="commission_level_default_' +ids+ '"  type="text" class="form-control commission_default commission_default_' +ids+ '" value="' +$(level_temp[li]).val()+ '" style="display:inline;width: '+96/parseInt(3)+'%;"/> ';
                                                    }
                                                    else
                                                    {
                                                        hh += '<input data-name="commission_level_default_' +ids+ '"  type="text" class="form-control commission_default commission_default_' +ids+ '" value="" style="display:inline;width: '+96/parseInt(3)+'%;"/> ';
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                for (var li = 0; li<3;li++)
                                                {
                                                    if (typeof (level_temp[li])!= "undefined")
                                                    {
                                                        hh += '<input data-name="commission_level__' +ids+ '"  type="text" class="form-control commission_level commission_level_' +ids+ '" value="' +$(level_temp[li]).val()+ '" style="display:inline;width: '+96/parseInt(3)+'%;"/> ';
                                                    }
                                                    else
                                                    {
                                                        hh += '<input data-name="commission_level__' +ids+ '"  type="text" class="form-control commission_level commission_level_' +ids+ '" value="" style="display:inline;width: '+96/parseInt(3)+'%;"/> ';
                                                    }
                                                }
                                            }
                                        }
                                        hh += '</td>';
                                        hh += '<input data-name="commission_id_' + ids+'"type="hidden" class="form-control commission_id commission_id_' + ids +'" value="' +(val.id=='undefined'?'':val.id )+'"/>';
                                        hh += '<input data-name="commission_ids"type="hidden" class="form-control commission_ids commission_ids_' + ids +'" value="' + ids +'"/>';
                                        hh += '<input data-name="commission_title_' + ids +'"type="hidden" class="form-control commission_title commission_title_' + ids +'" value="' +(val.title=='undefined'?'':val.title )+'"/></td>';
                                        hh += '<input data-name="commission_virtual_' + ids +'"type="hidden" class="form-control commission_virtual commission_virtual_' + ids +'" value="' +(val.virtual=='undefined'?'':val.virtual )+'"/></td>';
                                        hh += "</tr>";
                                    }
                                    html += hh;
                                    html += "</table>";
                                    $("#commission").html(html);
                                }

                                function setCol(cls){
                                    $("."+cls).val( $("."+cls+"_all").val());
                                }
                                function showItem(obj){
                                    var show = $(obj).get(0).checked?"1":"0";
                                    $(obj).parents('.spec_item_item').find('.spec_item_show:eq(0)').val(show);
                                }
                                function nofind(){
                                    var img=event.srcElement;
                                    img.src="./resource/image/module-nopic-small.jpg";
                                    img.onerror=null;
                                }

                                function choosetemp(id){
                                    $('#modal-module-chooestemp').modal();
                                    $('#modal-module-chooestemp').data("temp",id);
                                }
                                function addtemp(){
                                    var id = $('#modal-module-chooestemp').data("temp");
                                    var temp_id = $('#modal-module-chooestemp').find("select").val();
                                    var temp_name = $('#modal-module-chooestemp option[value='+temp_id+']').text();
                                    //alert(temp_id+":"+temp_name);
                                    $("#temp_name_"+id).val(temp_name);
                                    $("#temp_id_"+id).val(temp_id);
                                    $('#modal-module-chooestemp .close').click();
                                    refreshOptions()
                                }
                            </script></div>

                        </div>
                        <div class="tab-pane " id="tab_des">
                            <div class="panel-body" style='padding:0;'>
                            <div class="form-group">
                                <label class="col-sm-2 form-control-static">商品详情</label>
                                <div class="col-sm-11">
                                    <script type="text/javascript" src="/ueditor/ueditor.config.js"></script>
                                    <script type="text/javascript" src="/ueditor/ueditor.all.min.js"></script>
                                    <script type="text/javascript" src="/ueditor/lang/zh-cn/zh-cn.js"></script>
                                    <link href="/ueditor/themes/default/css/ueditor.css">
                                    <textarea id="content" name="content" type="text/plain" style="height:300px;"></textarea>
                                    <script type="text/javascript">
                                        var ueditoroption = {
                                            'autoClearinitialContent' : false,
                                            'toolbars' : [['fullscreen', 'source', 'preview', '|', 'bold', 'italic', 'underline', 'strikethrough', 'forecolor', 'backcolor', '|',
                                                'justifyleft', 'justifycenter', 'justifyright', '|', 'insertorderedlist', 'insertunorderedlist', 'blockquote', 'emotion', 'insertvideo',
                                                'link', 'removeformat', '|', 'rowspacingtop', 'rowspacingbottom', 'lineheight','indent', 'paragraph', 'fontsize', '|',
                                                'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol',
                                                'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|', 'anchor', 'map', 'print', 'drafts']],
                                            'elementPathEnabled' : false,
                                            'initialFrameHeight': 300,
                                            'focus' : false,
                                            'maximumWords' : 9999999999999
                                        };
                                        var opts = {
                                            type :'image',
                                            direct : false,
                                            multi : true,
                                            tabs : {
                                                'upload' : 'active',
                                                'browser' : '',
                                                'crawler' : ''
                                            },
                                            path : '',
                                            dest_dir : '',
                                            global : false,
                                            thumb : false,
                                            width : 0
                                        };
                                        UE.registerUI('myinsertimage',function(editor,uiName){
                                            editor.registerCommand(uiName, {
                                                execCommand:function(){
                                                    require(['fileUploader'], function(uploader){
                                                        uploader.show(function(imgs){
                                                            if (imgs.length == 0) {
                                                                return;
                                                            } else if (imgs.length == 1) {
                                                                editor.execCommand('insertimage', {
                                                                    'src' : imgs[0]['url'],
                                                                    '_src' : imgs[0]['attachment'],
                                                                    'width' : '100%',
                                                                    'alt' : imgs[0].filename
                                                                });
                                                            } else {
                                                                var imglist = [];
                                                                for (i in imgs) {
                                                                    imglist.push({
                                                                        'src' : imgs[i]['url'],
                                                                        '_src' : imgs[i]['attachment'],
                                                                        'width' : '100%',
                                                                        'alt' : imgs[i].filename
                                                                    });
                                                                }
                                                                editor.execCommand('insertimage', imglist);
                                                            }
                                                        }, opts);
                                                    });
                                                }
                                            });
                                            var btn = new UE.ui.Button({
                                                name: '插入图片',
                                                title: '插入图片',
                                                cssRules :'background-position: -726px -77px',
                                                onclick:function () {
                                                    editor.execCommand(uiName);
                                                }
                                            });
                                            editor.addListener('selectionchange', function () {
                                                var state = editor.queryCommandState(uiName);
                                                if (state == -1) {
                                                    btn.setDisabled(true);
                                                    btn.setChecked(false);
                                                } else {
                                                    btn.setDisabled(false);
                                                    btn.setChecked(state);
                                                }
                                            });
                                            return btn;
                                        }, 19);

                                        $(function(){
                                            var ue = UE.getEditor('content', ueditoroption);
                                            $('#content').data('editor', ue);
                                            $('#content').parents('form').submit(function() {
                                                if (ue.queryCommandState('source')) {
                                                    ue.execCommand('source');
                                                }
                                            });
                                        });
                                    </script>            </div>
                            </div>
                            <div class="form-group" >
                                <div class="col-sm-11 bcontent" style="display: none;">
                                    <script type="text/javascript" src="/ueditor/ueditor.config.js"></script>
                                    <script type="text/javascript" src="/ueditor/ueditor.all.min.js"></script>
                                    <script type="text/javascript" src="/ueditor/lang/zh-cn/zh-cn.js"></script>
                                    <textarea id="buycontent" name="buycontent" type="text/plain" style="height:300px;"></textarea>
                                    <script type="text/javascript">
                                        var ueditoroption = {
                                            'autoClearinitialContent' : false,
                                            'toolbars' : [['fullscreen', 'source', 'preview', '|', 'bold', 'italic', 'underline', 'strikethrough', 'forecolor', 'backcolor', '|',
                                                'justifyleft', 'justifycenter', 'justifyright', '|', 'insertorderedlist', 'insertunorderedlist', 'blockquote', 'emotion', 'insertvideo',
                                                'link', 'removeformat', '|', 'rowspacingtop', 'rowspacingbottom', 'lineheight','indent', 'paragraph', 'fontsize', '|',
                                                'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol',
                                                'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|', 'anchor', 'map', 'print', 'drafts']],
                                            'elementPathEnabled' : false,
                                            'initialFrameHeight': 300,
                                            'focus' : false,
                                            'maximumWords' : 9999999999999
                                        };
                                        var opts = {
                                            type :'image',
                                            direct : false,
                                            multi : true,
                                            tabs : {
                                                'upload' : 'active',
                                                'browser' : '',
                                                'crawler' : ''
                                            },
                                            path : '',
                                            dest_dir : '',
                                            global : false,
                                            thumb : false,
                                            width : 0
                                        };
                                        UE.registerUI('myinsertimage',function(editor,uiName){
                                            editor.registerCommand(uiName, {
                                                execCommand:function(){
                                                    require(['fileUploader'], function(uploader){
                                                        uploader.show(function(imgs){
                                                            if (imgs.length == 0) {
                                                                return;
                                                            } else if (imgs.length == 1) {
                                                                editor.execCommand('insertimage', {
                                                                    'src' : imgs[0]['url'],
                                                                    '_src' : imgs[0]['attachment'],
                                                                    'width' : '100%',
                                                                    'alt' : imgs[0].filename
                                                                });
                                                            } else {
                                                                var imglist = [];
                                                                for (i in imgs) {
                                                                    imglist.push({
                                                                        'src' : imgs[i]['url'],
                                                                        '_src' : imgs[i]['attachment'],
                                                                        'width' : '100%',
                                                                        'alt' : imgs[i].filename
                                                                    });
                                                                }
                                                                editor.execCommand('insertimage', imglist);
                                                            }
                                                        }, opts);
                                                    });
                                                }
                                            });
                                            var btn = new UE.ui.Button({
                                                name: '插入图片',
                                                title: '插入图片',
                                                cssRules :'background-position: -726px -77px',
                                                onclick:function () {
                                                    editor.execCommand(uiName);
                                                }
                                            });
                                            editor.addListener('selectionchange', function () {
                                                var state = editor.queryCommandState(uiName);
                                                if (state == -1) {
                                                    btn.setDisabled(true);
                                                    btn.setChecked(false);
                                                } else {
                                                    btn.setDisabled(false);
                                                    btn.setChecked(state);
                                                }
                                            });
                                            return btn;
                                        }, 19);

                                        $(function(){
                                            var ue = UE.getEditor('buycontent', ueditoroption);
                                            $('#buycontent').data('editor', ue);
                                            $('#buycontent').parents('form').submit(function() {
                                                if (ue.queryCommandState('source')) {
                                                    ue.execCommand('source');
                                                }
                                            });
                                        });
                                    </script>
                                </div>

                            </div>
                                <div class="form-group">
                                    <input type="submit" value="保存商品" class="btn btn-primary"/>
                                </div>
                        </div>

                        </div></div>
                    </div>
                </div>
            </div>

        </form>


        <script type="text/javascript">
            window.type = "1";
            window.virtual = "0";
            require(['bootstrap'], function () {
                $('#myTab a').click(function (e) {
                    $('#tab').val( $(this).attr('href'));
                    e.preventDefault();
                    $(this).tab('show');
                })
            });
            $(function () {

                $(':radio[name=isverify]').click(function () {
                    window.type = $("input[name='isverify']:checked").val();

                    if (window.type == '2') {
                        $(':checkbox[name=cash]').attr("checked",false);
                        $(':checkbox[name=cash]').parent().hide();
                    } else {
                        $(':checkbox[name=cash]').parent().show();
                    }
                })

                $(':radio[name=type]').click(function () {
                    window.type = $("input[name='type']:checked").val();
                    window.virtual = $("#virtual").val();
                    if(window.type=='1'){
                        $('.dispatch_info').show();
                    } else {
                        $('.dispatch_info').hide();
                    }
                    if (window.type == '2') {
                        $('.send-group').show();
                    } else {
                        $('.send-group').hide();
                    }
                    if (window.type == '3') {
                        if ($('#virtual').val() == '0') {
                            $('.choosetemp').show();
                        }
                    }
                    if (window.type == '2' || window.type == '3') {
                        $(':checkbox[name=cash]').attr("checked",false);
                        $(':checkbox[name=cash]').parent().hide();
                    } else {
                        $(':checkbox[name=cash]').parent().show();

                    }
                })

                $(":checkbox[name='buyshow']").click(function () {
                    if ($(this).prop('checked')) {
                        $(".bcontent").show();
                    }
                    else {
                        $(".bcontent").hide();
                    }
                })

                $(':radio[name=buyshow]').click(function () {
                    window.buyshow = $("input[name='buyshow']:checked").val();

                    if(window.buyshow=='1'){
                        $('.bcontent').show();
                    } else {
                        $('.bcontent').hide();
                    }
                })
            })

            window.optionchanged = false;

            $('form').submit(function(){
                var check = true;

                $(".tp_title,.tp_name").each(function(){
                    var val = $(this).val();
                    if(!val){
                        $('#myTab a[href="#tab_diyform"]').tab('show');
                        $(this).focus(),$('form').attr('stop',1),tip.msgbox.err('自定义表单字段名称不能为空!');
                        check =false;
                        return false;
                    }
                });

                var diyformtype = $(':radio[name=diyformtype]:checked').val();

                if (diyformtype == 2) {
                    if(kw == 0) {
                        $('#myTab a[href="#tab_diyform"]').tab('show');
                        $(this).focus(),$('form').attr('stop',1),tip.msgbox.err('请先添加自定义表单字段再提交!');
                        check =false;
                        return false;
                    }
                }

                if(!check){return false;}

                window.type = $("input[name='type']:checked").val();
                window.virtual = $("#virtual").val();
                if ($("#goodsname").isEmpty()) {
                    $('#myTab a[href="#tab_basic"]').tab('show');
                    $('form').attr('stop',1);
                    $(this).focus(),$('form').attr('stop',1),tip.msgbox.err('请填写商品名称!');
                    return false;
                }

                var inum = 0;
                $('.gimgs').find('.img-thumbnail').each(function(){
                    inum++;
                });
                if(inum == 0){
                    $('#myTab a[href="#tab_basic"]').tab('show');
                    $('form').attr('stop',1),tip.msgbox.err('请上传商品图片!');
                    return false;
                }


                var full = true;
                if (window.type == '3') {
                    if (window.virtual != '0') {  //如果单规格，不能有规格
                        if ($('#hasoption').get(0).checked) {
                            $('form').attr('stop',1),tip.msgbox.err('您的商品类型为：虚拟物品(卡密)的单规格形式，需要关闭商品规格！');
                            return false;
                        }
                    }
                    else {

                        var has = false;
                        $('.spec_item_virtual').each(function () {
                            has = true;
                            if ($(this).val() == '' || $(this).val() == '0') {
                                $('#myTab a[href="#tab_option"]').tab('show');
                                $(this).next().focus();
                                $('form').attr('stop',1),tip.msgbox.err('请选择虚拟物品模板!');
                                full = false;
                                return false;
                            }
                        });
                        if (!has) {
                            $('#myTab a[href="#tab_option"]').tab('show');
                            $('form').attr('stop',1),tip.msgbox.err('您的商品类型为：虚拟物品(卡密)的多规格形式，请添加规格！');
                            return false;
                        }
                    }
                }
                else if(window.type=='10'){
                    var spec_itemlen = $(".spec_item").length;
                    if (!$('#hasoption').get(0).checked || spec_itemlen<1) {
                        $('#myTab a[href="#tab_option"]').tab('show');
                        $('form').attr('stop',1),tip.msgbox.err('您的商品类型为：话费流量充值，需要开启并设置商品规格！');
                        return false;
                    }
                    if(spec_itemlen>1){
                        $('#myTab a[href="#tab_option"]').tab('show');
                        $('form').attr('stop',1),tip.msgbox.err('您的商品类型为：话费流量充值，只可添加一个规格！');
                        return false;
                    }
                }
                if (!full) {
                    return false;
                }

                full = checkoption();
                if (!full) {
                    $('form').attr('stop',1),tip.msgbox.err('请输入规格名称!');
                    return false;
                }
                if (optionchanged) {
                    $('#myTab a[href="#tab_option"]').tab('show');
                    $('form').attr('stop',1),tip.msgbox.err('规格数据有变动，请重新点击 [刷新规格项目表] 按钮!');
                    return false;
                }
                var spec_item_title = 1;
                $(".spec_item").each(function (i) {
                    var _this = this;
                    if($(_this).find(".spec_item_title").length == 0){
                        spec_item_title = 0;
                    }
                });
                if(spec_item_title == 0){
                    $('form').attr('stop',1),tip.msgbox.err('详细规格没有填写,请填写详细规格!');
                    return false;
                }
                $('form').attr('stop',1);
                //处理规格
                optionArray();
                isdiscountDiscountsArray();
                discountArray();
                commissionArray();
                $('form').removeAttr('stop');
                return true;
            });

        </script>

    </div>

    <script language='javascript'>
        require(['bootstrap'], function ($) {
            $('[data-toggle="tooltip"]').tooltip({
                container: $(document.body)
            });
            $('[data-toggle="popover"]').popover({
                container: $(document.body)
            });
        });


        function check_ewei_shopv2_upgrade() {

            require(['util'], function (util) {
                if (util.cookie.get('checkeweishopv2upgrade_sys')) {
                    return;
                }
                $.post('http://abc.5xieys.cn/web/index.php?c=site&a=entry&m=ewei_shopv2&do=web&r=system.auth.upgrade.check', function (ret) {
                    if (ret && ret.status == '1') {

                        var result = ret.result;
                        if(result.filecount>0 || result.database || result.upgrades){

                            var html = '<div id="ewei-shopv2-upgrade-tips" class="tips-upgrade">';
                            html+='<span class="tclose" onclick="check_ewei_shopv2_upgrade_hide();"><i class="fa fa-times-circle fa-2x"></i></span>';
                            html+= '<div class="title">检测到更新</div>';
                            html+='<div class="text"> 新版本 ' + result.version + " RELEASE " + result.release;
                            html+=',请尽快更新! </div>';
                            html+='<div class="buttons"><a href="http://abc.5xieys.cn/web/index.php?c=site&a=entry&m=ewei_shopv2&do=web&r=system.auth.upgrade" class="btn btn-warning btn-sm">立即去更新</a></div></div>';
                            $('body').prepend(html);
                        }
                    }
                },'json');
            });
        }
        function check_ewei_shopv2_upgrade_hide() {
            require(['util'], function (util) {
                util.cookie.set('checkeweishopv2upgrade_sys', 1, 3600);
                $('#ewei-shopv2-upgrade-tips').fadeOut(150);
            });
        }
        $(function () {
            setTimeout( function() {
                check_ewei_shopv2_upgrade();
            },4000);
        });

        $(function () {
            $('.page-content').show();
            $('.img-thumbnail').each(function () {
                if ($(this).attr('src').indexOf('nopic.jpg') != -1) {
                    $(this).attr('src', "../addons/ewei_shopv2/static/images/nopic.jpg");
                }
            })
            $.ajax({
                url: "http://abc.5xieys.cn/web/index.php?c=site&a=entry&m=ewei_shopv2&do=web&r=util.task",
                async:false,
                cache: false
            });
        });
    </script>
</div>
<script src="/js/adminedit.js"></script>